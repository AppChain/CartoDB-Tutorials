<!DOCTYPE html>
<html>
<head>
<title>State laws</title>

<script type="text/javascript" src="js/libs/vecnik/core.js"></script>
<script type="text/javascript" src="js/libs/vecnik/settings.js"></script>
<script type="text/javascript" src="js/libs/vecnik/mercator.js"></script>
<script type="text/javascript" src="js/libs/vecnik/geometry.js"></script>
<script type="text/javascript" src="js/libs/vecnik/model.js"></script>
<script type="text/javascript" src="js/libs/vecnik/renderer.js"></script>
<script type="text/javascript" src="js/libs/vecnik/shader.js"></script>


<script type="text/javascript" src="js/libs/vecnik/cartodb.sql.js"></script>
<script type="text/javascript" src="js/libs/vecnik/cartodb.provider.js"></script>

<!-- carto -->
<script type='text/javascript' src='js/libs/underscore.js'></script>
<script type='text/javascript' src='js/libs/carto.js'></script>

<script type="text/javascript" src="js/libs/modestmaps.js"></script>
<script type="text/javascript" src="js/libs/vecnik/vecnik.modestmaps.js"></script>

<script type="text/javascript" src="js/libs/vecnik/carto.js"></script>

<script type="text/javascript">
    var map;
    function initMap() {
        VECNIK.Carto.init(function(carto) {
            VECNIK.Carto.compile(
              "#world { line-width: 2; line-color: #f00; [TYPEY='test']{ line-width: 2; } [ZOOM = 0]{ line-width: 2; } }"
              , function() {});
        });
        
        var template = 'http://b.tiles.mapbox.com/v3/mapbox.mapbox-streets/{Z}/{X}/{Y}.png';
        template = 'http://b.tiles.mapbox.com/v3/mapbox.mapbox-light/{Z}/{X}/{Y}.png64';
        var subdomains = [ '', 'a.', 'b.', 'c.' ];
        var provider = new MM.TemplatedLayer(template, subdomains);

        var dataSource = new VECNIK.CartoDB.API({
           user: 'viz2',
           //user: 'jatorre',
           //user: 'staging',
           //user: 'mapnik-tests',
           //table: 'countries_final',
           table: 'laws_by_state',
           //table: 'nyc_buildings',
           //table: 'ny_districts',
           //table: 'barcelona_osm_line',
           columns: ['charge_youth_as_adults','mandates_separation','permit_age_under_18','some_circumstances_mixed','youth_in_adult_facilities'], //do not include the_geom or cartodb_id, are implicit
           ENABLE_CLIPPING: false,
           ENABLE_SIMPLIFY: false,
           ENABLE_FIXING: false,
           ENABLE_SNAPPING: false,
           debug: true
        });

        var shader = new VECNIK.CartoShader({
            'polygon-fill': '#020202'
        });

        var vector_layer = new VECNIK.MM.CanvasProvider(dataSource, shader);
        fg = new MM.Layer(vector_layer);

        map = new MM.Map(document.getElementById('map'), [fg])
        
        if(!location.hash) {
          
          map.setCenterZoom(new MM.Location(40.4942, -111.1671), 4);
        }
        var hash = new MM.Hash(map);

        var code = document.getElementById('code');
        var codeOld= '';
        var compileShader = _.debounce(function() {
            VECNIK.Carto.compile(code.value , function(shaderData) {
                if(shaderData) {
                  shader.compile(shaderData);
                }
            });
          }, 200);
        code.onkeyup = function() {
          if(code.value != codeOld) {
            compileShader();
            codeOld = code.value;
          }
        }
        compileShader(code.value);

    }
</script>
<style>
html, body, #map {
  background: black;
  width: 100%; height: 100%;
  padding: 0;
  margin: 0;
}
#livecode {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 450px;
  padding-left: 10px;
  box-shadow: 0px 0px 5px 6px #ccc;
}
textarea {
  color: rgba(0,0,0,0.9);
  background-color:rgba(255,255,255,0.92);
  position: absolute;
  left: 10px;
  top: 0;
  bottom: 0;
  padding: 0;
  margin: 0;
  border: none;
  font-family: monospace;
  font-size: 14px;
  width: 350px;
  border: 0;
  outline: none;

}
          /* code */
.highlight {
  font-family: monospace;
  font-size: 19px;
}


</style>
</head>
   <body onload="initMap()">
   <div id="map"></div>
  <!--<div id="livecode" class="highlight">-->
   </div>
   <textarea id="code">
#laws_by_state {
  polygon-fill: #ff00f0;
  [zoom > 12] {
    line-color: #555;
    line-width: 0.3;
  }
  [charge_youth_as_adults=true] {
    polygon-fill: #777;
    polygon-opacity: 0.7;
    line-width: 5;
    [mandates_separation=true] {
      polygon-fill: #0000ff;
      line-width: 5;
    }
    [permit_age_under_18=true] {
      polygon-fill: #ff0000;
      line-width: 5;
    }
    [some_circumstances_mixed=true] {
      polygon-fill: #0066FF;
      line-width: 5;
    }
    [youth_in_adult_facilities=true] {
      polygon-fill: #ff6600;
      line-width: 5;
    }
  }
}
   </textarea>
</body>
</html>
